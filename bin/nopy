#!/bin/bash

if [[ -z "$1" ]]; then
    echo "usage: $0 username@remotehost" 1>&2
    exit 1
fi

set -e

mkdir -p ~/.ssh
touch ~/.ssh/authorized_keys

if [[ ! -f ~/.ssh/id_dsa.pub ]]; then
    ssh-keygen -t dsa
    cat ~/.ssh/id_dsa.pub >> ~/.ssh/authorized_keys
fi

chmod go-w ~/
chmod go-rwx ~/.ssh
chmod go-rwx ~/.ssh/authorized_keys

scp ~/.ssh/id_dsa.pub "$1":"~"

ssh "$1" "bash -s" << EOF
    mkdir -p ~/.ssh
    touch ~/.ssh/authorized_keys

    cat id_dsa.pub >> ~/.ssh/authorized_keys

    chmod go-w ~/
    chmod go-rwx ~/.ssh
    chmod go-rwx ~/.ssh/authorized_keys

    rm ~/id_dsa.pub